{% extends "app/layout.html" %}
{% load static %}
{% block content %}

<div id="{{ obj_name }}" class="dashboard-bg w-100 h-100" style="min-height:100vh;width:100vw;overflow-x:hidden;">
    <!-- Add User Modal -->
    <div class="modal fade" id="add_user_modal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 1.2rem;">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold" id="addUserModalLabel">
                        <i class="fa-solid fa-user-plus me-2"></i>Add New Cardiologist
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <form @submit.prevent="registerAccount()">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="first_name" class="form-label fw-semibold">First Name</label>
                                <input type="text" class="form-control" id="first_name" v-model="first_name" required placeholder="Enter first name">
                            </div>
                            <div class="col-md-6">
                                <label for="last_name" class="form-label fw-semibold">Last Name</label>
                                <input type="text" class="form-control" id="last_name" v-model="last_name" required placeholder="Enter last name">
                            </div>
                            <div class="col-12">
                                <label for="email" class="form-label fw-semibold">Email Address</label>
                                <input type="email" class="form-control" id="email" v-model="email" required placeholder="cardiologist@example.com">
                            </div>
                            <div class="col-12">
                                <label for="username" class="form-label fw-semibold">Username</label>
                                <input type="text" class="form-control" id="username" v-model="username" required placeholder="Choose a username">
                            </div>
                            <div class="col-md-6">
                                <label for="password" class="form-label fw-semibold">Password</label>
                                <div class="input-group">
                                    <input :type="showPassword ? 'text' : 'password'" class="form-control" id="password" v-model="password" required placeholder="Enter password">
                                    <button class="btn btn-outline-secondary" type="button" @click="showPassword = !showPassword">
                                        <i :class="showPassword ? 'fa-solid fa-eye-slash' : 'fa-solid fa-eye'"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="reenter_password" class="form-label fw-semibold">Confirm Password</label>
                                <input type="password" class="form-control" id="reenter_password" v-model="reenter_password" required placeholder="Re-enter password">
                            </div>
                        </div>
                        <div class="alert alert-info border-0 mt-3 mb-0" style="background-color: #e8f4fd;">
                            <small><i class="fa-solid fa-info-circle me-1"></i>The new user will be automatically activated and can login immediately.</small>
                        </div>
                        <div class="mt-4 d-flex gap-2">
                            <button type="submit" class="btn btn-primary dashboard-btn flex-fill" :disabled="loading_state.ADDING_USER">
                                <span v-if="loading_state.ADDING_USER" class="spinner-border spinner-border-sm me-2"></span>
                                <i v-else class="fa-solid fa-user-plus me-2"></i>
                                <span v-if="loading_state.ADDING_USER">Adding User...</span>
                                <span v-else>Add User</span>
                            </button>
                            <button type="button" class="btn btn-outline-secondary dashboard-btn" data-bs-dismiss="modal">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Modal -->
    <div class="modal fade" id="message_modal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 1.2rem;">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold" id="messageModalLabel">[[ info.TITLE ]]</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="mb-0">[[ info.MESSAGE ]]</p>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-primary dashboard-btn" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid pt-5 px-3 px-md-5" style="max-width:100vw; margin-top: 4.5rem;">
        <div class="row justify-content-center">
            <div class="col-12 col-xl-11">
                <!-- Header Section -->
                <div class="dashboard-header mb-4">
                    <div class="row align-items-center">
                        <div class="col-12 col-md-6">
                            <h2 class="fw-bold mb-2 dashboard-title">
                                <i class="fa-solid fa-users-gear"></i> User Management
                            </h2>
                            <p class="dashboard-desc mb-0">
                                Manage all user accounts, activate or deactivate users, and review user details below.
                            </p>
                        </div>
                        <div class="col-12 col-md-6 text-md-end mt-3 mt-md-0">
                            <button class="btn btn-primary dashboard-btn" data-bs-toggle="modal" data-bs-target="#add_user_modal">
                                <i class="fa-solid fa-user-plus me-2"></i>Add New User
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Statistics Overview Cards -->
                <div class="row g-4 mb-4" v-if="lists.CARDIOLOGIST">
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="stat-card card h-100 border-0 dashboard-card">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div class="stat-icon bg-gradient-cardiologist text-white">
                                        <i class="fa-solid fa-users"></i>
                                    </div>
                                    <span class="badge bg-gradient-cardiologist text-white">Total</span>
                                </div>
                                <div>
                                    <h3 class="stat-number mb-2">[[ lists.CARDIOLOGIST.count || 0 ]]</h3>
                                    <h6 class="stat-label text-muted mb-2">Total Users</h6>
                                    <p class="stat-description text-muted small mb-0">
                                        Registered cardiologists in system
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="stat-card card h-100 border-0 dashboard-card">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div class="stat-icon bg-gradient-patient text-white">
                                        <i class="fa-solid fa-user-check"></i>
                                    </div>
                                    <span class="badge bg-gradient-patient text-white">Active</span>
                                </div>
                                <div>
                                    <h3 class="stat-number mb-2">
                                        [[ lists.CARDIOLOGIST.results.filter(c => c.user.is_active).length ]]
                                    </h3>
                                    <h6 class="stat-label text-muted mb-2">Active Users</h6>
                                    <p class="stat-description text-muted small mb-0">
                                        Currently active accounts
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-md-12 col-lg-4">
                        <div class="stat-card card h-100 border-0 dashboard-card">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div class="stat-icon bg-gradient-dataset text-white">
                                        <i class="fa-solid fa-user-xmark"></i>
                                    </div>
                                    <span class="badge bg-gradient-dataset text-white">Inactive</span>
                                </div>
                                <div>
                                    <h3 class="stat-number mb-2">
                                        [[ lists.CARDIOLOGIST.results.filter(c => !c.user.is_active).length ]]
                                    </h3>
                                    <h6 class="stat-label text-muted mb-2">Inactive Users</h6>
                                    <p class="stat-description text-muted small mb-0">
                                        Deactivated accounts
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Table Card -->
                <div class="card dashboard-card mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h5 class="card-title mb-1" style="color: #2d3748; font-weight: 600;">
                                    <i class="fa-solid fa-table-list me-2"></i>User List
                                </h5>
                                <p class="text-muted small mb-0">Viewing all registered cardiologists</p>
                            </div>
                        </div>

                        <div v-if="loading_state.CARDIOLOGIST" class="text-center py-5">
                            {% include 'app/constants/loading.html' %}
                        </div>

                        <div v-else>
                            <div class="table-responsive" v-if="lists.CARDIOLOGIST">
                                <table class="table table-hover align-middle mb-0">
                                    <thead style="background-color: #f8fafc;">
                                        <tr>
                                            <th scope="col" class="fw-semibold text-muted">ID</th>
                                            <th scope="col" class="fw-semibold text-muted">Full Name</th>
                                            <th scope="col" class="fw-semibold text-muted">Username</th>
                                            <th scope="col" class="fw-semibold text-muted d-none d-lg-table-cell">Email</th>
                                            <th scope="col" class="fw-semibold text-muted">Status</th>
                                            <th scope="col" class="fw-semibold text-muted text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="cardiologist in lists.CARDIOLOGIST.results" style="border-bottom: 1px solid #e2e8f0;">
                                            <td class="fw-medium">
                                                <span class="text-primary">#[[ cardiologist.user.id ]]</span>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar-circle me-2">
                                                        [[ cardiologist.user.first_name.charAt(0) ]][[ cardiologist.user.last_name.charAt(0) ]]
                                                    </div>
                                                    <div>
                                                        <div class="fw-medium">
                                                            [[ cardiologist.user.first_name ]] [[ cardiologist.user.last_name ]]
                                                        </div>
                                                        <div class="text-muted small d-lg-none">
                                                            [[ cardiologist.user.email ]]
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-light text-dark border">
                                                    <i class="fa-solid fa-at"></i> [[ cardiologist.user.username ]]
                                                </span>
                                            </td>
                                            <td class="d-none d-lg-table-cell">
                                                <span class="text-muted">
                                                    <i class="fa-solid fa-envelope me-1"></i>[[ cardiologist.user.email ]]
                                                </span>
                                            </td>
                                            <td>
                                                <span v-if="cardiologist.user.is_active" class="badge" style="background: linear-gradient(90deg, #43cea2 0%, #185a9d 100%); padding: 0.5rem 0.75rem;">
                                                    <i class="fa-solid fa-circle-check"></i> Active
                                                </span>
                                                <span v-else class="badge bg-secondary" style="padding: 0.5rem 0.75rem;">
                                                    <i class="fa-solid fa-circle-xmark"></i> Inactive
                                                </span>
                                            </td>
                                            <td class="text-end">
                                                <div class="btn-group" role="group">
                                                    <button v-if="cardiologist.user.is_active" 
                                                            class="btn btn-sm btn-danger dashboard-btn" 
                                                            @click="activate(cardiologist.user)"
                                                            title="Deactivate User">
                                                        <i class="fa-solid fa-user-slash"></i>
                                                        <span class="d-none d-md-inline ms-1">Deactivate</span>
                                                    </button>
                                                    <button v-else 
                                                            class="btn btn-sm btn-success dashboard-btn" 
                                                            @click="activate(cardiologist.user)"
                                                            title="Activate User">
                                                        <i class="fa-solid fa-user-check"></i>
                                                        <span class="d-none d-md-inline ms-1">Activate</span>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>

                                <!-- Empty State -->
                                <div v-if="!lists.CARDIOLOGIST.results || lists.CARDIOLOGIST.results.length === 0" class="text-center py-5">
                                    <i class="fa-solid fa-users-slash" style="font-size: 3rem; color: #cbd5e0; margin-bottom: 1rem;"></i>
                                    <p class="text-muted">No users found</p>
                                </div>
                            </div>

                            <!-- Pagination -->
                            <div v-if="lists.CARDIOLOGIST && lists.CARDIOLOGIST.results.length > 0" class="d-flex justify-content-between align-items-center mt-4 pt-3" style="border-top: 1px solid #e2e8f0;">
                                <div class="text-muted small">
                                    Showing [[ lists.CARDIOLOGIST.results.length ]] of [[ lists.CARDIOLOGIST.count ]] users
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary dashboard-btn" 
                                            :disabled="lists.CARDIOLOGIST.previous === null" 
                                            @click="switchPage('PREVIOUS')">
                                        <i class="fa-solid fa-chevron-left"></i>
                                        <span class="d-none d-sm-inline ms-1">Previous</span>
                                    </button>
                                    <button class="btn btn-outline-primary dashboard-btn" 
                                            :disabled="lists.CARDIOLOGIST.next === null" 
                                            @click="switchPage('NEXT')">
                                        <span class="d-none d-sm-inline me-1">Next</span>
                                        <i class="fa-solid fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    html, body {
        height: 100%;
        width: 100vw;
        margin: 0;
        padding: 0;
        background: none;
        overflow-x: hidden;
    }
    .dashboard-bg {
        background: linear-gradient(135deg, #f8fafc 0%, #e0e7ef 100%);
        min-height: 100vh;
        min-width: 100vw;
        width: 100vw;
        position: relative;
        overflow-x: hidden;
    }
    #{{ obj_name }} {
        min-height: 100vh;
        min-width: 100vw;
        width: 100vw;
        position: relative;
        overflow-x: hidden;
    }
    .dashboard-title {
        color: #2d3748;
        text-shadow: 1px 2px 8px rgba(255,95,109,0.08);
    }
    .dashboard-desc {
        color: #4a5568;
        opacity: 0.9;
    }
    .dashboard-card {
        border-radius: 1.2rem;
        background: #fff;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.10);
        
    }
    .dashboard-card:hover {
        transform: translateY(-3px) scale(1.01);
        box-shadow: 0 1.5rem 3rem rgba(255,95,109,0.10)!important;
    }
    .stat-card {
        border-radius: 1.2rem;
        background: #fff;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.10);
        transition: transform 0.3s, box-shadow 0.3s;
    }
    .stat-card:hover {
        transform: translateY(-3px) scale(1.01);
        box-shadow: 0 1.5rem 3rem rgba(255,95,109,0.10)!important;
    }
    .stat-icon {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        box-shadow: 0 2px 8px rgba(255,95,109,0.08);
    }
    .bg-gradient-patient {
        background: linear-gradient(90deg, #ff5f6d 0%, #ffc371 100%);
    }
    .bg-gradient-cardiologist {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }
    .bg-gradient-dataset {
        background: linear-gradient(90deg, #43cea2 0%, #185a9d 100%);
    }
    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: #2d3748;
        line-height: 1;
    }
    .stat-label {
        font-size: 0.875rem;
        font-weight: 600;
        letter-spacing: 0.025em;
        text-transform: uppercase;
    }
    .stat-description {
        font-size: 0.875rem;
        line-height: 1.5;
    }
    .avatar-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
        flex-shrink: 0;
    }
    .badge {
        padding: 0.35rem 0.75rem;
        font-weight: 600;
        font-size: 0.75rem;
        border-radius: 0.7rem;
    }
    .dashboard-btn {
        border-radius: 0.7rem;
        font-weight: 500;
        transition: all 0.2s ease;
        padding: 0.5rem 1rem;
    }
    .btn-primary {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        border: none;
    }
    .btn-primary:hover {
        background: linear-gradient(90deg, #764ba2 0%, #667eea 100%) !important;
        box-shadow: 0 0.5rem 1rem rgba(102,126,234,0.15);
        transform: translateY(-2px);
    }
    .btn-outline-primary {
        border-color: #667eea;
        color: #667eea;
    }
    .btn-outline-primary:hover {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%) !important;
        border-color: #667eea !important;
        color: #fff !important;
        box-shadow: 0 0.5rem 1rem rgba(102,126,234,0.15);
        transform: translateY(-2px);
    }
    .btn-outline-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    .btn-outline-secondary {
        border-radius: 0.7rem;
    }
    .btn-danger.dashboard-btn:hover {
        background: linear-gradient(90deg, #ff5f6d 0%, #ffc371 100%) !important;
        border-color: #ff5f6d !important;
        box-shadow: 0 0.5rem 1rem rgba(255,95,109,0.15);
        transform: translateY(-2px);
    }
    .btn-success.dashboard-btn:hover {
        background: linear-gradient(90deg, #43cea2 0%, #185a9d 100%) !important;
        border-color: #43cea2 !important;
        box-shadow: 0 0.5rem 1rem rgba(67,206,162,0.15);
        transform: translateY(-2px);
    }
    .modal-content {
        border: none;
        box-shadow: 0 1rem 3rem rgba(0,0,0,0.175);
    }
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.15rem rgba(102,126,234,0.15);
    }
    .table {
        margin-bottom: 0;
    }
    .table thead th {
        border-bottom: 2px solid #e2e8f0;
        padding: 1rem;
        font-size: 0.875rem;
    }
    .table tbody td {
        padding: 1rem;
        vertical-align: middle;
    }
    .table-hover tbody tr:hover {
        background-color: #f8fafc;
        cursor: pointer;
    }
    .gap-2 {
        gap: 0.5rem;
    }
    
    @media (max-width: 991.98px) {
        .dashboard-bg {
            background: #fff;
        }
        .dashboard-title {
            color: #212529;
            text-shadow: none;
        }
        .dashboard-desc {
            color: #6c757d !important;
        }
    }
    
    @media (max-width: 767.98px) {
        .dashboard-title {
            font-size: 1.75rem;
        }
        .stat-card {
            padding: 0.5rem;
        }
        .stat-icon {
            width: 48px;
            height: 48px;
        }
        .stat-number {
            font-size: 2rem;
        }
        .table {
            font-size: 0.875rem;
        }
        .table thead th,
        .table tbody td {
            padding: 0.75rem 0.5rem;
        }
        .avatar-circle {
            width: 32px;
            height: 32px;
            font-size: 0.75rem;
        }
        .badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
        }
        .dashboard-btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
    }
    
    @media (max-width: 575.98px) {
        .card-body {
            padding: 1rem !important;
        }
        .dashboard-header {
            margin-bottom: 1.5rem !important;
        }
    }
</style>

<script>
// CSRF token helper for axios
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

axios.defaults.xsrfHeaderName = "X-CSRFToken";
axios.defaults.xsrfCookieName = "csrftoken";
axios.interceptors.request.use(function(config) {
    if (!(/^http:.*/.test(config.url) || /^https:.*/.test(config.url))) {
        const csrftoken = getCookie('csrftoken');
        if (csrftoken) {
            config.headers['X-CSRFToken'] = csrftoken;
        }
    }
    return config;
}, function(error) {
    return Promise.reject(error);
});

new Vue({
    delimiters: ["[[", "]]"],
    el: "#" + '{{ obj_name }}',
    data: {
        lists: {},
        url_models: {},
        loading_state: {
            ADDING_USER: false,
            CARDIOLOGIST: false
        },
        endpoints: {},
        info: { MESSAGE: '', TITLE: '' },
        state: {
            'USER_ID': null
        },
        props: {
            'USER': null
        },
        username: "",
        password: "",
        email: "",
        first_name: "",
        last_name: "",
        reenter_password: "",
        showPassword: false
    },
    computed: {},
    mounted() {
        if (document.querySelector("#" + '{{ obj_name }}')) {
            console.log("Mounted " + '{{ obj_name }}' + " page.")
        }
        initializeModels(this, ['CARDIOLOGIST', 'USER'])
        universalGet(this, 'LIST_GET', 'CARDIOLOGIST', 'CARDIOLOGIST', 'CARDIOLOGIST', {page: 1})
        universalGet(this, 'LIST_GET', 'USER', 'USER', 'USER', {page: 1})
    },
    methods: {
        // Register new account
        async registerAccount() {
            const url = '/api/account-section/';
            
            if (this.password !== this.reenter_password) {
                this.info.TITLE = 'Validation Error';
                this.info.MESSAGE = 'Passwords do not match. Please try again.';
                this.hideAddUserModal();
                this.showMessageModal();
                return;
            }
            
            this.loading_state.ADDING_USER = true;
            
            try {
                const result = await axios.post(url, {
                    username: this.username,
                    password: this.password,
                    email: this.email,
                    first_name: this.first_name,
                    last_name: this.last_name
                });
                
                this.info.TITLE = 'Success';
                this.info.MESSAGE = 'New cardiologist account created successfully! The user can now login.';
                this.clearRegistrationForm();
                this.hideAddUserModal();
                this.showMessageModal();
                
                // Refresh the user list
                await universalGet(this, 'LIST_GET', 'CARDIOLOGIST', 'CARDIOLOGIST', 'CARDIOLOGIST', {page: 1});
            } catch (error) {
                this.info.TITLE = 'Registration Error';
                if (error.response && error.response.data) {
                    const errors = error.response.data;
                    let errorMessage = '';
                    for (const key in errors) {
                        if (Array.isArray(errors[key])) {
                            errorMessage += key.charAt(0).toUpperCase() + key.slice(1) + ': ' + errors[key].join(', ') + '<br>';
                        } else {
                            errorMessage += key.charAt(0).toUpperCase() + key.slice(1) + ': ' + errors[key] + '<br>';
                        }
                    }
                    this.info.MESSAGE = errorMessage || 'An error occurred during registration.';
                } else {
                    this.info.MESSAGE = 'An unexpected error occurred. Please try again.';
                }
                this.hideAddUserModal();
                this.showMessageModal();
            } finally {
                this.loading_state.ADDING_USER = false;
            }
        },

        // Clear registration form
        clearRegistrationForm() {
            this.username = "";
            this.password = "";
            this.email = "";
            this.first_name = "";
            this.last_name = "";
            this.reenter_password = "";
            this.showPassword = false;
        },

        // Hide add user modal properly
        hideAddUserModal() {
            const addModal = document.getElementById('add_user_modal');
            const modal = bootstrap.Modal.getInstance(addModal);
            if (modal) {
                modal.hide();
            }
            // Remove backdrop if it exists
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.remove();
            }
            // Remove modal-open class from body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
        },

        // Show message modal
        showMessageModal() {
            const messageModal = new bootstrap.Modal(document.getElementById('message_modal'));
            messageModal.show();
        },

        // Switch pagination pages
        async switchPage(option) {
            let page = 1;
            if (this.lists.CARDIOLOGIST && this.lists.CARDIOLOGIST.page) {
                page = this.lists.CARDIOLOGIST.page;
            }
            if (option === 'NEXT' && this.lists.CARDIOLOGIST.next) {
                page += 1;
            } else if (option === 'PREVIOUS' && this.lists.CARDIOLOGIST.previous && page > 1) {
                page -= 1;
            }
            await universalGet(this, 'LIST_GET', 'CARDIOLOGIST', 'CARDIOLOGIST', 'CARDIOLOGIST', {page: page});
        },

        // Activate or deactivate user
        async activate(user) {
            const url = `/api/get-update-destroy/user/${user.id}/`;
            try {
                const result = await axios.patch(url, { is_active: !user.is_active });
                
                this.info.TITLE = 'User Status Updated';
                this.info.MESSAGE = `User has been ${result.data.is_active ? 'activated' : 'deactivated'} successfully.`;
                this.showMessageModal();
                
                // Refresh the user list
                await universalGet(this, 'LIST_GET', 'CARDIOLOGIST', 'CARDIOLOGIST', 'CARDIOLOGIST', {page: 1});
            } catch (error) {
                console.error('Error updating user status:', error);
                this.info.TITLE = 'Status Update Error';
                
                if (error.response && error.response.data) {
                    this.info.MESSAGE = 'Failed to update user status: ' + JSON.stringify(error.response.data);
                } else if (error.response && error.response.status === 404) {
                    this.info.MESSAGE = 'User not found. Please refresh and try again.';
                } else {
                    this.info.MESSAGE = 'Failed to update user status. Please try again.';
                }
                
                this.showMessageModal();
            }
        },

        // Update cardiologist information
        async updateCardiologist(prop) {
            this.state.USER_ID = prop.user.id;
            this.props.USER = prop.user;

            await universalPatch(this, 'GET_UPDATE_DESTROY', 
                'USER', 'USER', 'USER', 
                'USER_ID', 'USER');

            await universalGet(this, 'LIST_GET', 'CARDIOLOGIST', 'CARDIOLOGIST', 'CARDIOLOGIST', {page: 1});
        }
    }
});
</script>
{% endblock %}