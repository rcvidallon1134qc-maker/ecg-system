{% extends "app/layout.html" %}
{% load static %}
{% block content %}

<div id="{{ obj_name }}" class="dashboard-bg w-100" style="min-height:100vh;width:100vw;overflow-x:hidden;">
    {% include 'app/constants/universal_loading_modal.html' %}
    
    <div class="container-fluid pt-5 px-3 px-md-5" style="max-width:100vw; margin-top: 4.5rem;">
        <div class="row justify-content-center">
            <div class="col-12 col-xl-11">
                
                <!-- Header Section -->
                <div class="dashboard-header mb-4">
                    <div class="row align-items-center">
                        <div class="col-12 col-md-8">
                            <h2 class="fw-bold mb-2 dashboard-title">
                                <i class="fa-solid fa-brain-circuit"></i> Patient ECG Analysis
                            </h2>
                            <p class="dashboard-desc mb-1">
                                <i class="fa-solid fa-info-circle me-2"></i>Read ECG data from patients using Arduino and AD8232 sensor
                            </p>
                            <p class="dashboard-desc mb-0">
                                <i class="fa-solid fa-user-md me-2"></i>Cardiologist: <span class="fw-semibold">{{ request.user.first_name }} {{ request.user.last_name }}</span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- ECG Data Reading Section -->
                <div class="row g-4 mb-4">
                    <div class="col-12 col-lg-6">
                        <div class="card dashboard-card border-0 h-100">
                            <div class="card-body p-4">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="stat-icon bg-gradient-cardiologist text-white me-3">
                                        <i class="fa-solid fa-microchip"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0" style="color: #2d3748; font-weight: 600;">Real-time Reading</h6>
                                        <small class="text-muted">Using Arduino & AD8232 Sensor</small>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Available Ports *</label>
                                    <select v-if="lists.PORTS" class="form-control" v-model="selected_port">
                                        <option value="">Select a port...</option>
                                        <option v-for="port in lists.PORTS.available_ports">
                                            [[ port ]]
                                        </option>
                                    </select>
                                </div>

                                <button class="btn btn-primary dashboard-btn w-100" @click="plotJS()">
                                    <i class="fa-solid fa-play me-2"></i>Read ECG Data
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-lg-6">
                        <div class="card dashboard-card border-0 h-100">
                            <div class="card-body p-4">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="stat-icon bg-gradient-patient text-white me-3">
                                        <i class="fa-solid fa-file-csv"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0" style="color: #2d3748; font-weight: 600;">Upload Raw Data</h6>
                                        <small class="text-muted">CSV or raw ECG file</small>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="fileInput" class="form-label fw-semibold">Select File *</label>
                                    <input class="form-control" v-model="fileUpload" type="file" id="fileInput" accept=".csv,.txt">
                                    <small class="text-muted d-block mt-2">
                                        <i class="fa-solid fa-lightbulb me-1"></i>Supported: CSV, TXT files
                                    </small>
                                </div>

                                <button class="btn btn-secondary dashboard-btn w-100" @click="plotJSRaw()">
                                    <i class="fa-solid fa-upload me-2"></i>Upload ECG Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Patient Information Section -->
                <div class="card dashboard-card border-0 mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center mb-4">
                            <div class="stat-icon bg-gradient-dataset text-white me-3">
                                <i class="fa-solid fa-user"></i>
                            </div>
                            <h5 class="mb-0" style="color: #2d3748; font-weight: 600;">Patient Information</h5>
                        </div>

                        <div class="row g-3">
                            <div class="col-12 col-md-4">
                                <label class="form-label fw-semibold">First Name</label>
                                <input type="text" v-model="props.PATIENT.first_name" class="form-control" :disabled="state.SELECTED_PATIENT" placeholder="Enter first name">
                            </div>

                            <div class="col-12 col-md-4">
                                <label class="form-label fw-semibold">Middle Name</label>
                                <input type="text" v-model="props.PATIENT.middle_name" class="form-control" :disabled="state.SELECTED_PATIENT" placeholder="Enter middle name">
                            </div>

                            <div class="col-12 col-md-4">
                                <label class="form-label fw-semibold">Last Name</label>
                                <input type="text" v-model="props.PATIENT.last_name" class="form-control" :disabled="state.SELECTED_PATIENT" placeholder="Enter last name">
                            </div>
                        </div>

                        <div class="mt-4 d-flex gap-2 flex-wrap">
                            <button class="btn btn-primary dashboard-btn flex-grow-1" @click="filterPatient()">
                                <i class="fa-solid fa-magnifying-glass me-2"></i>Search Patient(s)
                            </button>
                            <button class="btn btn-outline-danger dashboard-btn flex-grow-1" @click="clearFilters()">
                                <i class="fa-solid fa-trash me-2"></i>Clear Filters
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ECG Graph Display -->
                <div class="card dashboard-card border-0 mb-4">
                    <div class="card-body p-4">
                        <h5 class="mb-4" style="color: #2d3748; font-weight: 600;">
                            <i class="fa-solid fa-chart-line me-2" style="color: #667eea;"></i>ECG Graph
                        </h5>
                        <div id="ecg-graph" style="width:100%; min-height: 400px; background: #f8fafc; border-radius: 0.7rem;"></div>
                    </div>
                </div>

                <!-- ECG Prediction Results -->
                <div v-if="prediction_result.show" class="card dashboard-card border-0 mb-4">
                    <div class="card-body p-4">
                        <h5 class="mb-4" style="color: #2d3748; font-weight: 600;">
                            <i class="fa-solid fa-stethoscope me-2" style="color: #667eea;"></i>ECG Prediction Results
                        </h5>
                        
                        <div class="row g-4">
                            <!-- Result Card -->
                            <div class="col-12 col-md-6">
                                <div class="result-card p-4 h-100" :class="prediction_result.is_normal ? 'result-normal' : 'result-arrhythmia'">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="result-icon me-3">
                                            <i :class="prediction_result.is_normal ? 'fa-solid fa-heart-pulse' : 'fa-solid fa-heart-crack'"></i>
                                        </div>
                                        <div>
                                            <p class="text-muted small mb-1">ECG Result</p>
                                            <h4 class="mb-0 fw-bold">[[ prediction_result.result ]]</h4>
                                        </div>
                                    </div>
                                    <p class="mb-0 small" v-if="prediction_result.is_normal">
                                        <i class="fa-solid fa-circle-check me-1"></i>The ECG reading shows normal sinus rhythm
                                    </p>
                                    <p class="mb-0 small" v-else>
                                        <i class="fa-solid fa-triangle-exclamation me-1"></i>Abnormal heart rhythm detected
                                    </p>
                                </div>
                            </div>

                            <!-- Heart Condition Card -->
                            <div class="col-12 col-md-6">
                                <div class="result-card p-4 h-100" :class="prediction_result.is_strong ? 'result-strong' : 'result-weak'">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="result-icon me-3">
                                            <i :class="prediction_result.is_strong ? 'fa-solid fa-shield-heart' : 'fa-solid fa-heart'"></i>
                                        </div>
                                        <div>
                                            <p class="text-muted small mb-1">Heart Condition</p>
                                            <h4 class="mb-0 fw-bold">[[ prediction_result.condition ]]</h4>
                                        </div>
                                    </div>
                                    <p class="mb-0 small" v-if="prediction_result.is_strong">
                                        <i class="fa-solid fa-circle-check me-1"></i>Heart shows strong and regular patterns
                                    </p>
                                    <p class="mb-0 small" v-else>
                                        <i class="fa-solid fa-triangle-exclamation me-1"></i>Heart shows weak or irregular patterns
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Information -->
                        <div class="mt-4 p-3 bg-light rounded-3">
                            <div class="d-flex align-items-start">
                                <i class="fa-solid fa-info-circle text-primary me-2 mt-1"></i>
                                <div>
                                    <p class="mb-1 fw-semibold small">Analysis Details</p>
                                    <p class="mb-0 text-muted small">[[ prediction_result.message ]]</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Patient List Section -->
                <div class="card dashboard-card border-0">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center justify-content-between mb-4">
                            <div>
                                <h5 class="mb-1" style="color: #2d3748; font-weight: 600;">
                                    <i class="fa-solid fa-list me-2"></i>Patient List
                                </h5>
                                <p class="text-muted small mb-0">View and select patients for ECG analysis</p>
                            </div>
                        </div>

                        <div v-if="loading_state.PATIENT" class="text-center py-5">
                            {% include 'app/constants/loading.html' %}
                        </div>

                        <div v-else>
                            <div class="table-responsive" v-if="lists.PATIENT">
                                <table class="table table-hover align-middle mb-0">
                                    <thead style="background-color: #f8fafc;">
                                        <tr>
                                            <th scope="col" class="fw-semibold text-muted">Patient ID</th>
                                            <th scope="col" class="fw-semibold text-muted">Full Name</th>
                                            <th scope="col" class="fw-semibold text-muted text-end">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="patient in lists.PATIENT.results" style="border-bottom: 1px solid #e2e8f0;">
                                            <td class="fw-medium">
                                                <span class="text-primary">#[[ patient.id ]]</span>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar-circle me-2">
                                                        [[ patient.first_name.charAt(0) ]][[ patient.last_name.charAt(0) ]]
                                                    </div>
                                                    <div>
                                                        <div class="fw-medium">[[ patient.first_name ]] [[ patient.middle_name ]] [[ patient.last_name ]]</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="text-end">
                                                <button class="btn btn-sm btn-primary dashboard-btn" @click="selectPatient(patient)">
                                                    <i class="fa-solid fa-check me-1"></i>
                                                    <span class="d-none d-md-inline">Select</span>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>

                                <!-- Empty State -->
                                <div v-if="!lists.PATIENT.results || lists.PATIENT.results.length === 0" class="text-center py-5">
                                    <i class="fa-solid fa-inbox" style="font-size: 3rem; color: #cbd5e0; margin-bottom: 1rem;"></i>
                                    <p class="text-muted">No patients found</p>
                                </div>
                            </div>

                            <!-- Pagination -->
                            <div v-if="lists.PATIENT && lists.PATIENT.results.length > 0" class="d-flex justify-content-between align-items-center mt-4 pt-3" style="border-top: 1px solid #e2e8f0;">
                                <div class="text-muted small">
                                    Showing [[ lists.PATIENT.results.length ]] of [[ lists.PATIENT.count ]] patients
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary dashboard-btn" :disabled="lists.PATIENT.previous === null" @click="switchPage('PREVIOUS')">
                                        <i class="fa-solid fa-chevron-left"></i>
                                        <span class="d-none d-sm-inline ms-1">Previous</span>
                                    </button>
                                    <button class="btn btn-outline-primary dashboard-btn" :disabled="lists.PATIENT.next === null" @click="switchPage('NEXT')">
                                        <span class="d-none d-sm-inline me-1">Next</span>
                                        <i class="fa-solid fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<style>
    html, body {
        height: 100%;
        width: 100vw;
        margin: 0;
        padding: 0;
        background: none;
        overflow-x: hidden;
    }

    .dashboard-bg {
        background: linear-gradient(135deg, #f8fafc 0%, #e0e7ef 100%);
        min-height: 100vh;
        min-width: 100vw;
        width: 100vw;
        position: relative;
        overflow-x: hidden;
    }

    .dashboard-title {
        color: #2d3748;
        text-shadow: 1px 2px 8px rgba(255,95,109,0.08);
    }

    .dashboard-desc {
        color: #4a5568;
        opacity: 0.9;
        font-size: 0.95rem;
    }

    .dashboard-card {
        border-radius: 1.2rem;
        background: #fff;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.10);
        transition: transform 0.3s, box-shadow 0.3s;
    }

    .dashboard-card:hover {
        transform: translateY(-3px) scale(1.01);
        box-shadow: 0 1.5rem 3rem rgba(255,95,109,0.10) !important;
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        box-shadow: 0 2px 8px rgba(255,95,109,0.08);
        flex-shrink: 0;
    }

    .bg-gradient-patient {
        background: linear-gradient(90deg, #ff5f6d 0%, #ffc371 100%);
    }

    .bg-gradient-cardiologist {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }

    .bg-gradient-dataset {
        background: linear-gradient(90deg, #43cea2 0%, #185a9d 100%);
    }

    .avatar-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
        flex-shrink: 0;
    }

    .dashboard-btn {
        border-radius: 0.7rem;
        font-weight: 500;
        transition: all 0.2s ease;
        padding: 0.5rem 1rem;
    }

    .btn-primary {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        border: none;
    }

    .btn-primary:hover {
        background: linear-gradient(90deg, #764ba2 0%, #667eea 100%) !important;
        box-shadow: 0 0.5rem 1rem rgba(102,126,234,0.15);
        transform: translateY(-2px);
    }

    .btn-secondary.dashboard-btn {
        background: linear-gradient(90deg, #f59e0b 0%, #f97316 100%);
        border: none;
        color: #fff;
    }

    .btn-secondary.dashboard-btn:hover {
        background: linear-gradient(90deg, #f97316 0%, #f59e0b 100%) !important;
        box-shadow: 0 0.5rem 1rem rgba(245,158,11,0.15);
        transform: translateY(-2px);
    }

    .btn-outline-primary {
        border-color: #667eea;
        color: #667eea;
    }

    .btn-outline-primary:hover {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%) !important;
        border-color: #667eea !important;
        color: #fff !important;
        box-shadow: 0 0.5rem 1rem rgba(102,126,234,0.15);
        transform: translateY(-2px);
    }

    .btn-outline-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .btn-outline-danger {
        border-color: #ef4444;
        color: #ef4444;
    }

    .btn-outline-danger:hover {
        background: linear-gradient(90deg, #ff5f6d 0%, #ffc371 100%) !important;
        border-color: #ff5f6d !important;
        color: #fff !important;
        box-shadow: 0 0.5rem 1rem rgba(255,95,109,0.15);
        transform: translateY(-2px);
    }

    .form-control {
        border-radius: 0.7rem;
        border: 1px solid #e2e8f0;
        font-size: 0.95rem;
    }

    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.15rem rgba(102,126,234,0.15);
    }

    .form-control:disabled {
        background-color: #f3f4f6;
        color: #9ca3af;
    }

    .form-label {
        color: #2d3748;
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    .table {
        margin-bottom: 0;
    }

    .table thead th {
        border-bottom: 2px solid #e2e8f0;
        padding: 1rem;
        font-size: 0.875rem;
    }

    .table tbody td {
        padding: 1rem;
        vertical-align: middle;
    }

    .table-hover tbody tr:hover {
        background-color: #f8fafc;
        cursor: pointer;
    }

    .gap-2 {
        gap: 0.5rem;
    }

    /* Prediction Result Styles */
    .result-card {
        border-radius: 1rem;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .result-normal {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        border-color: #10b981;
    }

    .result-arrhythmia {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border-color: #ef4444;
    }

    .result-strong {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border-color: #3b82f6;
    }

    .result-weak {
        background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
        border-color: #f59e0b;
    }

    .result-icon {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .result-normal .result-icon {
        color: #10b981;
    }

    .result-arrhythmia .result-icon {
        color: #ef4444;
    }

    .result-strong .result-icon {
        color: #3b82f6;
    }

    .result-weak .result-icon {
        color: #f59e0b;
    }

    .result-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 991.98px) {
        .dashboard-bg {
            background: #fff;
        }

        .dashboard-title {
            color: #212529;
            text-shadow: none;
            font-size: 1.75rem;
        }

        .dashboard-desc {
            color: #6c757d !important;
            font-size: 0.9rem;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            font-size: 1.1rem;
        }

        #ecg-graph {
            min-height: 350px !important;
        }
    }

    @media (max-width: 767.98px) {
        .dashboard-title {
            font-size: 1.5rem;
        }

        .table {
            font-size: 0.875rem;
        }

        .table thead th,
        .table tbody td {
            padding: 0.75rem 0.5rem;
        }

        .avatar-circle {
            width: 32px;
            height: 32px;
            font-size: 0.7rem;
        }

        .dashboard-btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }

        .btn-sm {
            padding: 0.375rem 0.5rem;
            font-size: 0.75rem;
        }

        .form-label {
            font-size: 0.875rem;
        }

        .form-control {
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
        }

        .card-body {
            padding: 1rem !important;
        }

        #ecg-graph {
            min-height: 280px !important;
        }

        .row g-3 > [class*="col-"] {
            padding: 0.5rem;
        }
    }

    @media (max-width: 575.98px) {
        .dashboard-title {
            font-size: 1.25rem;
        }

        .dashboard-desc {
            font-size: 0.85rem;
        }

        .card-body {
            padding: 1rem !important;
        }

        .dashboard-header {
            margin-bottom: 1rem !important;
        }

        .container-fluid {
            padding-left: 0.75rem !important;
            padding-right: 0.75rem !important;
        }

        .row g-4 > [class*="col-"] {
            padding: 0.5rem;
        }

        #ecg-graph {
            min-height: 250px !important;
        }

        .table {
            font-size: 0.8rem;
        }

        .btn {
            font-size: 0.75rem;
            padding: 0.5rem 0.5rem;
        }

        .btn i {
            font-size: 0.7rem;
        }

        .flex-wrap {
            gap: 0.5rem !important;
        }
    }
</style>

<script>
// CSRF token helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

new Vue({
    delimiters: ["[[", "]]"],
    el: "#" + '{{ obj_name }}',
    data: {
        fileUpload: null,
        selected_port: '',
        loading_state: {},
        lists: {},
        url_models: {},
        endpoints: {},
        info: {
            'MESSAGE': '',
            'TITLE': 'Sample Title',
            'STATE': false
        },
        props: {
            PATIENT: {
                id: "",
                first_name: "",
                middle_name: "",
                last_name: "",
                birth: "",
            },
            PREDICTION: {
                "id": ""
            }
        },
        state: {
            SELECTED_PATIENT: false,
            SELECTED_FILE: null,
            COUNTER: 0,
            X_VALUES: [],
            Y_VALUES: []
        },
        prediction_result: {
            show: false,
            result: '',
            condition: '',
            is_normal: false,
            is_strong: false,
            message: ''
        }
    },
    mounted() {
        if (document.querySelector("#" + '{{ obj_name }}')) {
            console.log("Mounted " + '{{ obj_name }}' + " page.")
        }

        initializeModels(this, ["PATIENT"]);
        universalGet(this, "LIST_GET", "PATIENT", "PATIENT", "PATIENT", {
            page: 1,
        });

        this.getPorts()

        Vue.set(this.lists, 'PORTS', [])
        Vue.set(this.info, 'STATE', false)
        Vue.set(this.props, 'PREDICTION', {})
        
        setInterval(() => {
            this.state.COUNTER = this.state.COUNTER + 1
        }, 3000)
    },
    methods: {
        async selectPatient(prop) {
            this.props.PATIENT = prop;
            await universalGet(
                this,
                "LIST_GET",
                "PATIENT",
                "PATIENT",
                "PATIENT",
                this.getFilters()
            );
            this.state.SELECTED_PATIENT = true;
        },

        async clearFilters() {
            this.info.TITLE = ''
            this.info.MESSAGE = ''
            this.props.PREDICTION = { "id": "" }
            this.props.PATIENT = {
                id: "",
                first_name: "",
                middle_name: "",
                last_name: "",
                birth: "",
            };
            this.prediction_result = {
                show: false,
                result: '',
                condition: '',
                is_normal: false,
                is_strong: false,
                message: ''
            };
            await universalGet(
                this,
                "LIST_GET",
                "PATIENT",
                "PATIENT",
                "PATIENT",
                this.getFilters()
            );
            this.state.SELECTED_PATIENT = false;
        },

        async switchPage(option) {
            var action = "";

            if (option === "NEXT") {
                action = this.lists.PATIENT.next;
            } else if (option === "PREVIOUS") {
                action = ensurePageParam(this.lists.PATIENT.previous);
            }

            await universalGet(
                this,
                "LIST_GET",
                "PATIENT",
                "PATIENT",
                "PATIENT",
                null,
                action
            );
        },

        async filterPatient() {
            this.state.SELECTED_PATIENT = false;
            await universalGet(
                this,
                "LIST_GET",
                "PATIENT",
                "PATIENT",
                "PATIENT",
                this.getFilters()
            );
            if (this.lists.PATIENT) {
                if (this.lists.PATIENT.count < 1) {
                    this.info.MESSAGE = "Oh no! No results found.";
                    this.info.TITLE = "Notification";
                    openModal("message_modal");
                    this.clearFilters();
                }
            }
        },

        getFilters() {
            const filters = { page: 1 };

            if (this.props.PATIENT.first_name !== "") {
                filters["first_name"] = this.props.PATIENT.first_name;
            }

            if (this.props.PATIENT.middle_name !== "" && this.props.PATIENT.middle_name !== null) {
                filters["middle_name"] = this.props.PATIENT.middle_name;
            }

            if (this.props.PATIENT.last_name !== "") {
                filters["last_name"] = this.props.PATIENT.last_name;
            }

            return filters;
        },

        async predictECGData(rates) {
            axios.defaults.headers.common['X-CSRFToken'] = getCookie('csrftoken')
            let response = await axios.patch('/api/serial-ports/', {"rates": rates, "prediction_id": this.props.PREDICTION.id});

            // Update prediction results
            if (response.data) {
                const remarks = (response.data.remarks || '').toLowerCase();
                const message = (response.data.message || '').toLowerCase();

                // Determine if result is normal or arrhythmia
                const isNormal = remarks.includes('normal');

                // Improved heart condition logic
                let isStrong = false;
                if ((remarks.includes('weak') || message.includes('weak') || remarks.includes('irregular') || message.includes('irregular'))) {
                    isStrong = false;
                } else if (
                    remarks.includes('strong') || message.includes('strong') ||
                    remarks.includes('regular') || message.includes('regular') ||
                    remarks.includes('normal') || message.includes('normal')
                ) {
                    isStrong = true;
                } else {
                    // fallback: use avgRate if backend is ambiguous
                    const avgRate = rates.reduce((a, b) => a + b, 0) / rates.length;
                    isStrong = avgRate > 500;
                }

                this.prediction_result = {
                    show: true,
                    result: isNormal ? 'Normal' : 'Arrhythmia',
                    condition: isStrong ? 'Strong' : 'Weak',
                    is_normal: isNormal,
                    is_strong: isStrong,
                    message: response.data.message
                };

                // Scroll to ECG graph when result is revealed
                this.$nextTick(() => {
                    const graph = document.getElementById('ecg-graph');
                    if (graph) {
                        graph.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }

            return response
        },

        async getPorts() {
            try {
                const url = '/api/serial-ports/'
                const result = await axios.get(url)
                if (result) {
                    Vue.set(this.lists, 'PORTS', result.data)
                }
            } catch (error) {
                console.error("Error fetching ports:", error);
            }
        },

        async testWS() {
            const ws = new WebSocket("ws://localhost:8080/ws/some_path/");
            let closeTimeout;

            const resetTimeout = () => {
                if (closeTimeout) clearTimeout(closeTimeout);
                closeTimeout = setTimeout(() => {
                    console.log("⌛ No messages received in 10 seconds. Closing WebSocket.");
                    ws.close();
                }, 10000);
            };

            ws.onopen = () => {
                console.log("✅ WebSocket connected!");
                resetTimeout();
            };

            ws.onmessage = (event) => {
                resetTimeout();

                try {
                    let data = JSON.parse(event.data);
                    let value = parseInt(data.message);
                    this.state.Y_VALUES.push(value)
                    this.state.COUNTER = this.state.COUNTER + 1
                    this.state.X_VALUES.push(this.state.COUNTER)

                    let trace = {
                        x: this.state.X_VALUES,
                        y: this.state.Y_VALUES,
                        mode: 'lines',
                        line: { color: '#667eea', width: 2 }
                    };

                    let layout = {
                        title: 'ECG-Style Graph',
                        xaxis: { title: 'Time' },
                        yaxis: { title: 'Amplitude' },
                        plot_bgcolor: '#f8fafc',
                        paper_bgcolor: '#f8fafc'
                    };

                    if (this.state.COUNTER > 50) {
                        this.state.COUNTER = 0
                        this.state.X_VALUES = []
                        this.state.Y_VALUES = []
                    }

                    // Only plot in the modal during real-time reading
                    if (document.getElementById('chart-graph')) {
                        Plotly.newPlot('chart-graph', [trace], layout);
                    }
                } catch (e) {
                    console.error("⚠️ Invalid WS message:", event.data, e);
                }
            };

            ws.onclose = () => {
                console.log("❌ WebSocket disconnected!");
                this.info.STATE = false
                closeModal('loading_message_modal')
            };
        },

        async plotJSRaw() {
            try {
                const csrftoken = getCookie("csrftoken");
                axios.defaults.headers.common["X-CSRFToken"] = csrftoken;

                const form_data = new FormData();
                const fileInput = document.getElementById('fileInput');
                const file = fileInput.files[0];
                form_data.append('file', file);
            
                const url = "/api/upload-csv/"
                const reading_result = await axios.post(url, form_data)

                this.info.STATE = true
                this.info.TITLE = 'Notification'
                this.info.MESSAGE = 'Reading ECG Data'
                openModal('loading_message_modal')

                axios.defaults.headers.common['X-CSRFToken'] = getCookie('csrftoken')

                const payload = {
                    "port": null,
                    "patient": this.props.PATIENT.id,
                    "raw": true,
                    "heart_rates": reading_result.data.data
                }

                let response = await axios.post('/api/serial-ports/', payload);
                let data = response.data;
                
                this.props.PREDICTION.id = response.data.prediction_id

                let xValues = [...Array(data.rates.length).keys()];
                let yValues = data.rates;
                
                this.info.MESSAGE = 'Predicting Fetched Data using GRU'
                const prediction = await this.predictECGData(data.rates)
        
                if (prediction) {
                    this.info.MESSAGE = prediction.data.message
                }

                let trace = {
                    x: xValues,
                    y: yValues,
                    mode: 'lines',
                    line: { color: '#667eea', width: 2 }
                };

                let layout = {
                    title: 'ECG-Style Graph',
                    xaxis: { title: 'Time' },
                    yaxis: { title: 'Amplitude' },
                    plot_bgcolor: '#f8fafc',
                    paper_bgcolor: '#f8fafc'
                };

                Plotly.newPlot('ecg-graph', [trace], layout);
            } catch (error) {
                console.error("Error fetching ECG data:", error);
                this.info.MESSAGE = 'Error processing ECG data. Please try again.'
            }

            this.info.STATE = false
        },

        async plotJS() {
            try {
                this.info.STATE = true
                this.info.TITLE = 'Notification'
                this.info.MESSAGE = 'Reading ECG Data'
                openModal('loading_message_modal')
                
                await this.testWS()

                axios.defaults.headers.common['X-CSRFToken'] = getCookie('csrftoken')

                const payload = {
                    "port": this.selected_port,
                    "patient": this.props.PATIENT.id
                }

                let response = await axios.post('/api/serial-ports/', payload);
                let data = response.data;

                this.props.PREDICTION.id = response.data.prediction_id

                let xValues = [...Array(data.rates.length).keys()];
                let yValues = data.rates;
                
                this.info.MESSAGE = 'Predicting Fetched Data using GRU'
                const prediction = await this.predictECGData(data.rates)
        
                if (prediction) {
                    this.info.MESSAGE = prediction.data.message
                }

                let trace = {
                    x: xValues,
                    y: yValues,
                    mode: 'lines',
                    line: { color: '#667eea', width: 2 }
                };

                let layout = {
                    title: 'ECG-Style Graph',
                    xaxis: { title: 'Time' },
                    yaxis: { title: 'Amplitude' },
                    plot_bgcolor: '#f8fafc',
                    paper_bgcolor: '#f8fafc'
                };

                Plotly.newPlot('ecg-graph', [trace], layout);
            } catch (error) {
                console.error("Error fetching ECG data:", error);
                this.info.MESSAGE = 'Error reading ECG data. Please try again.'
            }

            this.info.STATE = false
        }
    }
});
</script>
{% endblock %}