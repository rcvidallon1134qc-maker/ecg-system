{% extends "app/layout.html" %}
{% load static %}
{% block content %}

<div id="{{ obj_name }}" class="dashboard-bg w-100 h-100" style="min-height:100vh;width:100vw;overflow-x:hidden;">
    <div class="container-fluid pt-5 px-3 px-md-5" style="max-width:100vw; margin-top: 4.5rem;">
        <div class="row">
            {% include 'app/defined/show_graph.html' %}
            {% include 'app/defined-modals/training.html' %}
            
            <!-- Header Section -->
            <div class="dashboard-header mb-4">
                <div class="row align-items-center">
                    <div class="col-12 col-md-8">
                        <h2 class="fw-bold mb-2 dashboard-title">
                            <i class="fa-solid fa-brain-circuit"></i> Model Information
                        </h2>
                        <p class="dashboard-desc mb-0">Model metrics and training data overview</p>
                    </div>
                    <div class="col-12 col-md-4 text-md-end mt-3 mt-md-0">
                        <button class="btn btn-primary dashboard-btn" @click="trainModel()">
                            <i class="fa-solid fa-dumbbell"></i> Train Model
                        </button>
                    </div>
                </div>
            </div>

            <!-- Training Date Info -->
            <div class="mb-4">
                <div class="alert alert-info border-0 dashboard-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="d-flex align-items-center">
                        <i class="fa-solid fa-calendar-check me-2" style="font-size: 1.5rem;"></i>
                        <div>
                            <strong>Last Trained:</strong>
                            <span class="ms-2">
                                [[ lists.MODELINFO && lists.MODELINFO.length > 0 && lists.MODELINFO[0].last_trained_state ? lists.MODELINFO[0].last_trained_state : 'Not Yet Trained' ]]
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Model Metrics Cards -->
            <div class="row g-4 mb-5">
                <!-- Accuracy Card -->
                <div class="col-12 col-md-6 col-xl-3">
                    <div class="stat-card card h-100 border-0 dashboard-card">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="stat-icon bg-gradient-patient text-white">
                                    <i class="fa-solid fa-bullseye"></i>
                                </div>
                                <span class="badge bg-gradient-patient text-white">Metric</span>
                            </div>
                            <div>
                                <h3 class="stat-number mb-2">
                                    [[ lists.MODELINFO && lists.MODELINFO.length > 0 && lists.MODELINFO[0].accuracy ? (lists.MODELINFO[0].accuracy * 100).toFixed(2) : '0' ]]%
                                </h3>
                                <h6 class="stat-label text-muted mb-2">Accuracy</h6>
                                <p class="stat-description text-muted small mb-0">
                                    Overall prediction accuracy
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Precision Card -->
                <div class="col-12 col-md-6 col-xl-3">
                    <div class="stat-card card h-100 border-0 dashboard-card">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="stat-icon bg-gradient-cardiologist text-white">
                                    <i class="fa-solid fa-crosshairs"></i>
                                </div>
                                <span class="badge bg-gradient-cardiologist text-white">Metric</span>
                            </div>
                            <div>
                                <h3 class="stat-number mb-2">
                                    [[ lists.MODELINFO && lists.MODELINFO.length > 0 && lists.MODELINFO[0].precision ? (lists.MODELINFO[0].precision * 100).toFixed(2) : '0' ]]%
                                </h3>
                                <h6 class="stat-label text-muted mb-2">Precision</h6>
                                <p class="stat-description text-muted small mb-0">
                                    Positive prediction accuracy
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recall Card -->
                <div class="col-12 col-md-6 col-xl-3">
                    <div class="stat-card card h-100 border-0 dashboard-card">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="stat-icon bg-gradient-dataset text-white">
                                    <i class="fa-solid fa-chart-line"></i>
                                </div>
                                <span class="badge bg-gradient-dataset text-white">Metric</span>
                            </div>
                            <div>
                                <h3 class="stat-number mb-2">
                                    [[ lists.MODELINFO && lists.MODELINFO.length > 0 && lists.MODELINFO[0].recall ? (lists.MODELINFO[0].recall * 100).toFixed(2) : '0' ]]%
                                </h3>
                                <h6 class="stat-label text-muted mb-2">Recall</h6>
                                <p class="stat-description text-muted small mb-0">
                                    True positive detection rate
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- F1 Score Card -->
                <div class="col-12 col-md-6 col-xl-3">
                    <div class="stat-card card h-100 border-0 dashboard-card">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="stat-icon text-white" style="background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);">
                                    <i class="fa-solid fa-star"></i>
                                </div>
                                <span class="badge text-white" style="background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);">Metric</span>
                            </div>
                            <div>
                                <h3 class="stat-number mb-2">
                                    [[ lists.MODELINFO && lists.MODELINFO.length > 0 && lists.MODELINFO[0].f1_score ? (lists.MODELINFO[0].f1_score * 100).toFixed(2) : '0' ]]%
                                </h3>
                                <h6 class="stat-label text-muted mb-2">F1 Score</h6>
                                <p class="stat-description text-muted small mb-0">
                                    Harmonic mean of precision & recall
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Datasets Section -->
            <div class="dashboard-header mb-4">
                <h2 class="fw-bold mb-2 dashboard-title">
                    <i class="fa-solid fa-database"></i> Datasets
                </h2>
                <p class="dashboard-desc mb-0">Available datasets for arrhythmia and normal classification</p>
            </div>

            <div class="table-responsive mb-5">
                <div class="card dashboard-card">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h5 class="card-title mb-1" style="color: #2d3748; font-weight: 600;">Dataset List</h5>
                                <p class="text-muted small mb-0">Viewing all available datasets</p>
                            </div>
                        </div>
                        
                        <div v-if="lists.JSONDATASET">
                            <span v-if="loading_state.JSONDATA">
                                {% include 'app/constants/loading.html' %}
                            </span>
                            <span v-else>
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead style="background-color: #f8fafc;">
                                            <tr>
                                                <th scope="col" class="fw-semibold text-muted">Dataset ID</th>
                                                <th scope="col" class="fw-semibold text-muted">Remarks</th>
                                                <th scope="col" class="fw-semibold text-muted text-end">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="ecg in lists.JSONDATASET.results" style="border-bottom: 1px solid #e2e8f0;">
                                                <td class="fw-medium">#[[ ecg.id ]]</td>
                                                <td>[[ ecg.remarks ]]</td>
                                                <td class="text-end">
                                                    <button class="btn btn-sm btn-primary dashboard-btn" @click="parseData(ecg)">
                                                        <i class="fa-solid fa-eye"></i> View Graph
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </span>
                        </div>
                        
                        <div v-if="lists.JSONDATASET" class="d-flex justify-content-end mt-3 gap-2">
                            <button class="btn btn-outline-primary dashboard-btn" :disabled="lists.JSONDATASET.previous === null" @click="switchPage('PREVIOUS')">
                                <i class="fa-solid fa-chevron-left"></i> Previous
                            </button>
                            <button class="btn btn-outline-primary dashboard-btn" :disabled="lists.JSONDATASET.next === null" @click="switchPage('NEXT')">
                                Next <i class="fa-solid fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Testing Summary Section -->
            <div class="dashboard-header mb-4">
                <h2 class="fw-bold mb-2 dashboard-title">
                    <i class="fa-solid fa-file-lines"></i> Testing Summary
                </h2>
                <p class="dashboard-desc mb-0">View testing results and compare predictions with correct labels</p>
            </div>

            <div class="table-responsive mb-5">
                <div class="card dashboard-card">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h5 class="card-title mb-1" style="color: #2d3748; font-weight: 600;">Testing Results</h5>
                                <p class="text-muted small mb-0">Viewing all testing datasets with predictions</p>
                            </div>
                        </div>
                        
                        <div v-if="lists.TESTINGJSONDATASET">
                            <span v-if="loading_state.TESTINGJSONDATASET">
                                {% include 'app/constants/loading.html' %}
                            </span>
                            <span v-else>
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead style="background-color: #f8fafc;">
                                            <tr>
                                                <th scope="col" class="fw-semibold text-muted">Dataset ID</th>
                                                <th scope="col" class="fw-semibold text-muted">Correct Label</th>
                                                <th scope="col" class="fw-semibold text-muted">Predicted Label</th>
                                                <th scope="col" class="fw-semibold text-muted text-end">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="ecg in lists.TESTINGJSONDATASET.results" style="border-bottom: 1px solid #e2e8f0;">
                                                <td class="fw-medium">#[[ ecg.id ]]</td>
                                                <td>
                                                    <span class="badge" style="background: linear-gradient(90deg, #43cea2 0%, #185a9d 100%);">
                                                        [[ ecg.correct_remarks ]]
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);">
                                                        [[ ecg.answered_remarks ]]
                                                    </span>
                                                </td>
                                                <td class="text-end">
                                                    <button class="btn btn-sm btn-primary dashboard-btn" @click="parseData(ecg)">
                                                        <i class="fa-solid fa-eye"></i> View Graph
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </span>
                        </div>
                        
                        <div v-if="lists.TESTINGJSONDATASET" class="d-flex justify-content-end mt-3 gap-2">
                            <button class="btn btn-outline-primary dashboard-btn" :disabled="lists.TESTINGJSONDATASET.previous === null" @click="switchPageTesting('PREVIOUS')">
                                <i class="fa-solid fa-chevron-left"></i> Previous
                            </button>
                            <button class="btn btn-outline-primary dashboard-btn" :disabled="lists.TESTINGJSONDATASET.next === null" @click="switchPageTesting('NEXT')">
                                Next <i class="fa-solid fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    html, body {
        height: 100%;
        width: 100vw;
        margin: 0;
        padding: 0;
        background: none;
        overflow-x: hidden;
    }
    .dashboard-bg {
        background: linear-gradient(135deg, #f8fafc 0%, #e0e7ef 100%);
        min-height: 100vh;
        min-width: 100vw;
        width: 100vw;
        position: relative;
        overflow-x: hidden;
    }
    #{{ obj_name }} {
        min-height: 100vh;
        min-width: 100vw;
        width: 100vw;
        position: relative;
        overflow-x: hidden;
    }
    .dashboard-title {
        color: #2d3748;
        text-shadow: 1px 2px 8px rgba(255,95,109,0.08);
    }
    .dashboard-desc {
        color: #4a5568;
        opacity: 0.9;
    }
    .dashboard-card {
        border-radius: 1.2rem;
        background: #fff;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.10);
        transition: transform 0.3s, box-shadow 0.3s;
    }
    .dashboard-card:hover {
        transform: translateY(-3px) scale(1.01);
        box-shadow: 0 1.5rem 3rem rgba(255,95,109,0.10)!important;
    }
    .stat-card {
        border-radius: 1.2rem;
        background: #fff;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.10);
        transition: transform 0.3s, box-shadow 0.3s;
    }
    .stat-card:hover {
        transform: translateY(-3px) scale(1.01);
        box-shadow: 0 1.5rem 3rem rgba(255,95,109,0.10)!important;
    }
    .stat-icon {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        box-shadow: 0 2px 8px rgba(255,95,109,0.08);
    }
    .bg-gradient-patient {
        background: linear-gradient(90deg, #ff5f6d 0%, #ffc371 100%);
    }
    .bg-gradient-cardiologist {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }
    .bg-gradient-dataset {
        background: linear-gradient(90deg, #43cea2 0%, #185a9d 100%);
    }
    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: #2d3748;
        line-height: 1;
    }
    .stat-label {
        font-size: 0.875rem;
        font-weight: 600;
        letter-spacing: 0.025em;
        text-transform: uppercase;
    }
    .stat-description {
        font-size: 0.875rem;
        line-height: 1.5;
    }
    .badge {
        padding: 0.35rem 0.75rem;
        font-weight: 600;
        font-size: 0.75rem;
        border-radius: 0.7rem;
    }
    .dashboard-btn {
        border-radius: 0.7rem;
        font-weight: 500;
        transition: background 0.2s, color 0.2s, box-shadow 0.2s, transform 0.2s;
        padding: 0.5rem 1.25rem;
    }
    .dashboard-btn:hover {
        background: #ff5f6d !important;
        border-color: #ff5f6d !important;
        color: #fff !important;
        box-shadow: 0 0.5rem 1rem rgba(255,95,109,0.15);
        transform: translateY(-2px);
    }
    .btn-outline-primary {
        border-color: #ff5f6d;
        color: #ff5f6d;
    }
    .btn-outline-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .table {
        margin-bottom: 0;
    }
    .table thead th {
        border-bottom: 2px solid #e2e8f0;
        padding: 1rem;
    }
    .table tbody td {
        padding: 1rem;
    }
    .gap-2 {
        gap: 0.5rem;
    }
    @media (max-width: 991.98px) {
        .dashboard-bg {
            background: #fff;
        }
        .dashboard-title {
            color: #212529;
            text-shadow: none;
        }
        .dashboard-desc {
            color: #6c757d!important;
        }
    }
    @media (max-width: 767.98px) {
        .dashboard-bg {
            padding: 0 0.5rem;
        }
        .dashboard-title {
            font-size: 1.75rem;
        }
        .dashboard-card {
            padding: 0.5rem;
        }
        .stat-card {
            padding: 0.5rem;
        }
        .stat-icon {
            width: 48px;
            height: 48px;
        }
        .stat-number {
            font-size: 2rem;
        }
        .table {
            font-size: 0.875rem;
        }
        .dashboard-btn {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
        }
    }
</style>

<script>
new Vue({
    delimiters: ["[[", "]]"],
    el: "#" + '{{ obj_name }}',
    data: {
        loading_state: {},
        lists: {},
        url_models: {},
        endpoints: {},
        info: {
            'MESSAGE': '',
            'TITLE': 'Sample Title'
        },
        props: {},
        state: {
            'GRAPH': [],
            'PREDICTION_RESULT': {
                show: false,
                result: '',
                condition: '',
                is_normal: false,
                is_strong: false,
                message: ''
            }
        }
    },
    mounted() {
        if (document.querySelector("#" + '{{ obj_name }}')) {
            console.log("Mounted " + '{{ obj_name }}' + " page.")
        }
        initializeModels(this, ['JSONDATASET', 'TESTINGJSONDATASET', 'MODELINFO'])
        universalGet(this, 'LIST_CREATE', 'MODELINFO', 'MODELINFO', 'MODELINFO')
        universalGet(this,
            'LIST_GET',
            'JSONDATASET',
            'JSONDATASET',
            'JSONDATASET',
            {page:1}, ''
        )
        universalGet(this,
            'LIST_GET',
            'TESTINGJSONDATASET',
            'TESTINGJSONDATASET',
            'TESTINGJSONDATASET',
            {page:1}, ''
        )
        Vue.set(this.loading_state, 'TRAINING', false);
    },
    methods: {
        async trainModel () {
            openModal('training_modal')
            this.loading_state['TRAINING'] = true
            const url = '/api/train-model/'
            const result = await axios.get(url)
            if (result) {
                console.log(result)
            }
            this.loading_state['TRAINING'] = false
            universalGet(this, 'LIST_CREATE', 'MODELINFO', 'MODELINFO', 'MODELINFO')
        },
        plotJS() {
            try {
                let data = this.state.GRAPH
                let xValues = [...Array(data.rates.length).keys()];
                let yValues = data.rates;

                let trace = {
                    x: xValues,
                    y: yValues,
                    mode: 'lines',
                    line: { color: 'blue' }
                };

                let layout = {
                    title: 'ECG-Style Graph',
                    xaxis: { title: 'Time' },
                    yaxis: { title: 'Amplitude' }
                };
                Plotly.newPlot('ecg-graph', [trace], layout);
            } catch (error) {
                console.error("Error fetching ECG data:", error);
            }
        },
        parseData(props) {
            const data = JSON.parse(props.sequential_ecg)
            this.state.GRAPH = data
            this.info.TITLE = 'Showing Graph'
            
            // Set prediction results based on dataset remarks
            const remarks = props.remarks || props.correct_remarks || '';
            const isNormal = remarks.toLowerCase().includes('normal') || remarks.toLowerCase().includes('no disease');
            
            // Calculate average rate from ECG data for heart condition
            let rates = data.rates || [];
            const avgRate = rates.length > 0 ? rates.reduce((a, b) => a + b, 0) / rates.length : 0;
            const isStrong = avgRate > 500 && !remarks.toLowerCase().includes('weak');
            
            this.state.PREDICTION_RESULT = {
                show: true,
                result: isNormal ? 'Normal' : 'Arrhythmia',
                condition: isStrong ? 'Strong' : 'Weak',
                is_normal: isNormal,
                is_strong: isStrong,
                message: remarks
            };
            
            // Plot graph after modal opens for proper dimensions
            openModal('graph_modal')
            setTimeout(() => {
                this.plotJS()
            }, 150)
        },
        async switchPage (option) {
            var action = ''
            if (option === 'NEXT') {
                action = this.lists.JSONDATASET.next
            } else if (option === 'PREVIOUS') {
                action = ensurePageParam(this.lists.JSONDATASET.previous )
            }
            await universalGet(this, 
                'LIST_GET', 
                'JSONDATASET', 
                'JSONDATASET', 
                'JSONDATASET', 
                null,
                action)
        },
        async switchPageTesting (option) {
            var action = ''
            if (option === 'NEXT') {
                action = this.lists.TESTINGJSONDATASET.next
            } else if (option === 'PREVIOUS') {
                action = ensurePageParam(this.lists.TESTINGJSONDATASET.previous )
            }
            await universalGet(this, 
                'LIST_GET', 
                'TESTINGJSONDATASET', 
                'TESTINGJSONDATASET', 
                'TESTINGJSONDATASET', 
                null,
                action)
        },
    },
});
</script>
{% endblock %}